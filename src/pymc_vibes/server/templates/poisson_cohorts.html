{% extends "base.html" %} {% block content %}
<script>
  function poissonCohorts() {
    return {
      groupBy: ["cohort"],
      exposures: {},
      rawPosteriorData: null,
      sortedCohortNames: [],
      _module: null, // To store the imported module

      init() {
        import("/static/poisson_cohorts.js")
          .then((module) => {
            this._module = module;
            this.fetchAllAndRender(); // Initial call
            this.$watch("groupBy", () => this.fetchAllAndRender());
          })
          .catch((err) => {
            console.error("Error loading poisson cohorts module:", err);
            const container = document.getElementById("chart-container");
            if (container) {
              container.innerText =
                "Error loading visualization. See console for details.";
            }
          });
      },

      async fetchAllAndRender() {
        if (!this._module) return;

        this.rawPosteriorData = null;
        this.sortedCohortNames = [];
        this.renderExposureInputs([]);

        const { posteriorData, cohortNames } =
          await this._module.fetchAndRenderAll(this.groupBy);

        if (posteriorData) {
          this.rawPosteriorData = posteriorData;
          this.sortedCohortNames = Object.keys(this.rawPosteriorData).sort(
            (a, b) => {
              const summaryA = this.rawPosteriorData[a];
              const summaryB = this.rawPosteriorData[b];
              const meanA =
                summaryA.stats.data[0][summaryA.stats.columns.indexOf("mean")];
              const meanB =
                summaryB.stats.data[0][summaryB.stats.columns.indexOf("mean")];
              return meanA - meanB;
            }
          );
        } else if (cohortNames && cohortNames.length > 0) {
          this.sortedCohortNames = cohortNames.sort();
        }

        if (this.sortedCohortNames.length > 0) {
          this.renderExposureInputs(this.sortedCohortNames);
        }

        if (this.rawPosteriorData) {
          this.rerenderPosteriors();
        }
      },

      rerenderPosteriors() {
        if (!this._module || !this.rawPosteriorData) return;

        const scaledData = this._module.scalePosteriorData(
          this.rawPosteriorData,
          this.exposures
        );
        if (scaledData) {
          const container = document.getElementById("chart-container");
          this._module.renderPosteriors(
            container,
            scaledData,
            this.sortedCohortNames
          );
        }
      },

      renderExposureInputs(cohorts) {
        document
          .getElementById("group-by-container")
          ?.classList.remove("hidden");

        const container = document.getElementById("exposure-inputs");
        if (!container) return;
        container.innerHTML = "";

        const controlsContainer = document.getElementById(
          "exposure-controls-container"
        );
        if (cohorts && cohorts.length > 0) {
          controlsContainer.classList.remove("hidden");
          cohorts.forEach((cohortName) => {
            const inputGroup = document.createElement("div");
            inputGroup.className =
              "flex items-center justify-between space-x-2 mb-1";

            const label = document.createElement("label");
            label.className = "text-sm font-medium text-gray-600 truncate";
            label.innerText = cohortName;
            label.title = cohortName;

            const input = document.createElement("input");
            input.type = "number";
            input.step = "0.1";
            input.className =
              "w-28 text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500";
            input.dataset.cohort = cohortName;
            input.value = this.exposures[cohortName] || "1";

            input.addEventListener("blur", (e) => {
              if (e.target.value === "") {
                e.target.value = "1";
                e.target.dispatchEvent(new Event("change", { bubbles: true }));
              }
            });

            inputGroup.appendChild(label);
            inputGroup.appendChild(input);
            container.appendChild(inputGroup);
          });
        } else {
          controlsContainer.classList.add("hidden");
        }
      },

      handleExposureChange(event) {
        if (event.target.tagName !== "INPUT") return;

        const cohort = event.target.dataset.cohort;
        const value = event.target.value;
        const floatValue = parseFloat(value);

        if (value === "" || isNaN(floatValue) || floatValue === 1) {
          delete this.exposures[cohort];
        } else {
          this.exposures[cohort] = floatValue;
        }
        this.rerenderPosteriors();
      },
    };
  }
</script>
<div x-data="poissonCohorts()">
  <div class="flex flex-row gap-4 mb-4">
    <div
      id="group-by-container"
      class="p-4 border rounded-md bg-gray-50 hidden"
    >
      <h3 class="font-semibold text-lg mb-2">Group By Dimensions</h3>
      <div class="flex flex-wrap gap-x-6 gap-y-2">
        <label class="inline-flex items-center">
          <input
            type="checkbox"
            class="form-checkbox group-by-checkbox"
            value="cohort"
            x-model="groupBy"
          />
          <span class="ml-2">Cohort</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="checkbox"
            class="form-checkbox group-by-checkbox"
            value="event_type"
            x-model="groupBy"
          />
          <span class="ml-2">Event Type</span>
        </label>
      </div>
    </div>

    <div
      id="exposure-controls-container"
      class="p-4 border rounded-md bg-gray-50 hidden"
    >
      <h3 class="font-semibold text-lg mb-2">Relative Population Size</h3>
      <div id="exposure-inputs" @change="handleExposureChange($event)"></div>
    </div>
  </div>

  <div id="chart-container" data-experiment-name="{{ experiment.name }}"></div>
  <hr class="my-8" />
  <div id="global-timeline-container" class="mb-8"></div>
  <div id="timelines-container"></div>
</div>

{% endblock %}
